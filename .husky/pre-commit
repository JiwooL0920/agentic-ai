#!/bin/sh
# Branch Context Auto-Generator
# Creates/updates .ai/AGENTS/AGENTS-<branch>.md with context on each commit
# Uses intelligent templating (AI generation disabled for reliability)

# Exit on error
set -e

# Skip conditions
[ -n "$SKIP_BRANCH_CONTEXT" ] && exit 0
[ -n "$CI" ] && exit 0

# Get branch name (sanitize for filename: replace / with -)
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null | tr '/' '-')

# Skip detached HEAD or empty branch
[ -z "$BRANCH" ] && exit 0
[ "$BRANCH" = "HEAD" ] && exit 0

# Optional: Skip main/master branches (uncomment to enable)
# [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ] && exit 0

# Paths
CONTEXT_DIR=".ai/AGENTS"
CONTEXT_FILE="${CONTEXT_DIR}/AGENTS-${BRANCH}.md"

# Ensure directory exists
mkdir -p "$CONTEXT_DIR"

# Gather context
STAGED_FILES=$(git diff --cached --name-only 2>/dev/null | head -30)
STAGED_STAT=$(git diff --cached --stat 2>/dev/null | tail -15)
BRANCH_COMMITS=$(git log main..HEAD --oneline 2>/dev/null | head -15 || echo "")
RECENT_COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null | head -3 || echo "Initial commit")

# Calculate commit count properly (handle empty string case)
if [ -n "$BRANCH_COMMITS" ]; then
    COMMIT_COUNT=$(echo "$BRANCH_COMMITS" | wc -l | tr -d ' ')
else
    COMMIT_COUNT=0
fi

# Check if there are staged changes
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Infer branch purpose from branch name
BRANCH_PURPOSE=""
case "$BRANCH" in
    feature-*|feat-*) BRANCH_PURPOSE="Feature development: ${BRANCH#*-}" ;;
    fix-*|bugfix-*|hotfix-*) BRANCH_PURPOSE="Bug fix: ${BRANCH#*-}" ;;
    refactor-*) BRANCH_PURPOSE="Code refactoring: ${BRANCH#*-}" ;;
    chore-*) BRANCH_PURPOSE="Maintenance: ${BRANCH#*-}" ;;
    docs-*) BRANCH_PURPOSE="Documentation: ${BRANCH#*-}" ;;
    test-*) BRANCH_PURPOSE="Testing: ${BRANCH#*-}" ;;
    main|master) BRANCH_PURPOSE="Main development branch" ;;
    *) BRANCH_PURPOSE="Development work on: $BRANCH" ;;
esac

# Format staged files as list
STAGED_FILES_LIST=$(echo "$STAGED_FILES" | sed 's/^/- /')

# Create context file
cat > "$CONTEXT_FILE" << EOF
# Branch: ${BRANCH}

## Branch Purpose
${BRANCH_PURPOSE}

## Current Progress
- ${COMMIT_COUNT} commit(s) since main branch
- Working on files across the staged changes below

## Recent Changes
\`\`\`
${RECENT_COMMIT_MSG}
\`\`\`

## Files Modified
${STAGED_FILES_LIST}

## Changes Summary
\`\`\`
${STAGED_STAT}
\`\`\`

## Branch Commits (since main)
\`\`\`
${BRANCH_COMMITS:-No commits yet - this is a new branch or working on main}
\`\`\`

## Next Steps
Refer to commit messages and modified files for context on ongoing work.

## Technical Notes
- Auto-generated by pre-commit hook
- Updates on each commit to track branch progress

---
*Last updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*
EOF

git add "$CONTEXT_FILE"
echo "ðŸ“ Updated ${CONTEXT_FILE}"

exit 0
